<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HEVREKCMG6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HEVREKCMG6');
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Põllu Piirangute Kalkulaator</title>
<meta name="description" content="Põllumassiivi taimekaitse piirangute kalkulaator. Arvutab veekaitsevööndi, mittepõllumajandusliku maa ja elanike puhvervööndid vastavalt SPe3 nõuetele.">
<meta name="keywords" content="põllu piirangud, kalkulaator, põllumassiiv, PRIA, Keskkonnaamet, SPe3, taimekaitse, veekaitsevöönd, puhverala, mittepõllumajandusmaa, Eesti, maaregister">
<meta name="author" content="Rain Villemson">
<meta name="theme-color" content="#ffffff">
<link rel="canonical" href="https://veekaitse-arvutaja.vercel.app/">
<meta property="og:type" content="website">
<meta property="og:title" content="Põllu Piirangute Kalkulaator">
<meta property="og:description" content="Põllumassiivi taimekaitse piirangute kalkulaator. Arvutab veekaitsevööndi, mittepõllumajandusliku maa ja elanike puhvervööndid vastavalt SPe3 nõuetele.">
<meta property="og:url" content="https://veekaitse-arvutaja.vercel.app/">
<meta property="og:locale" content="et_EE">
<meta property="og:site_name" content="Põllu Piirangute Kalkulaator">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Põllu Piirangute Kalkulaator">
<meta name="twitter:description" content="Põllumassiivi taimekaitse piirangute kalkulaator. SPe3 veekaitsevööndi, mittepõllumajandusliku maa ja elanike puhvervööndid.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ───── 1. CSS Variables ───── */
:root{
  /* Backgrounds */
  --bg-base:#ffffff;--bg-surface:#f4f6f8;--bg-elevated:#ffffff;
  /* Mobile sheet */
  --sheet-peek:380px;
  /* Text */
  --text-primary:#1a1a2e;--text-secondary:#5a6578;--text-muted:#94a3b8;
  /* Accents */
  --accent:#16a34a;--accent-bright:#15803d;--accent-glow:rgba(22,163,74,.12);
  --danger:#dc2626;--warning:#d97706;--info:#2563eb;--water:#2563eb;--water-light:#1d4ed8;
  /* Borders */
  --border:#e2e8f0;--border-focus:#a3cfbb;
  /* Spacing scale */
  --sp-1:4px;--sp-2:8px;--sp-3:12px;--sp-4:16px;--sp-5:20px;--sp-6:24px;--sp-7:28px;--sp-8:32px;--sp-9:36px;--sp-10:40px;
  /* Radius */
  --radius-sm:8px;--radius-md:12px;--radius-lg:20px;
  /* Shadows */
  --shadow-sm:0 1px 2px rgba(0,0,0,.04),0 1px 4px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.07),0 2px 6px rgba(0,0,0,.04);--shadow-lg:0 8px 24px rgba(0,0,0,.1),0 4px 12px rgba(0,0,0,.05);
  /* Animation */
  --ease-out:cubic-bezier(.2,0,.38,.9);--duration-fast:.15s;--duration-normal:.25s;--duration-slow:.4s;
}
/* ───── Reset & Typography ───── */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-base);color:var(--text-primary);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.5}

/* ───── Focus & Accessibility ───── */
:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:var(--radius-sm)}
:focus:not(:focus-visible){outline:none}

/* ───── Scrollbar ───── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-focus)}
*{scrollbar-width:thin;scrollbar-color:var(--border) transparent}

/* ───── Layout: Desktop ───── */
.layout{display:grid;grid-template-columns:420px 1fr;min-height:100vh}

/* ───── Sidebar ───── */
.sidebar{padding:var(--sp-7) var(--sp-6);border-right:1px solid var(--border);overflow-y:auto;background:var(--bg-base)}
.logo{font-family:'JetBrains Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:var(--sp-1)}
h1{font-size:24px;font-weight:700;color:var(--text-primary);margin-bottom:var(--sp-1);line-height:1.3}
.subtitle{font-size:13px;color:var(--text-secondary);margin-bottom:var(--sp-7);line-height:1.6}

/* ───── Inputs ───── */
.input-group{margin-bottom:var(--sp-5)}
label{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:var(--sp-2);font-family:'JetBrains Mono',monospace}
.input-wrapper{position:relative;display:flex;align-items:center}
.input-icon{position:absolute;left:var(--sp-3);color:var(--text-muted);pointer-events:none;display:flex;align-items:center;transition:color var(--duration-fast) var(--ease-out)}
.input-wrapper:focus-within .input-icon{color:var(--accent)}
input[type="text"],input[type="number"]{width:100%;padding:var(--sp-3) var(--sp-4) var(--sp-3) 40px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-size:16px;font-family:'Plus Jakarta Sans',sans-serif;transition:all var(--duration-normal) var(--ease-out);outline:none;min-height:48px}
input:focus{border-color:var(--accent);background:var(--bg-elevated);box-shadow:0 0 0 3px var(--accent-glow)}
input::placeholder{color:var(--text-muted);opacity:.7;transition:opacity var(--duration-fast) var(--ease-out)}
input:focus::placeholder{opacity:.4}
.info-note{font-size:12px;color:var(--text-muted);margin-top:var(--sp-1);line-height:1.4}

/* ───── Button ───── */
.btn{width:100%;padding:var(--sp-3) var(--sp-5);border:none;border-radius:var(--radius-md);font-size:15px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;cursor:pointer;transition:all var(--duration-normal) var(--ease-out);min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-2)}
.btn-primary{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;box-shadow:var(--shadow-sm)}
.btn-primary:hover{background:linear-gradient(135deg,#15803d,#16a34a);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.btn-primary:active{transform:scale(.98);box-shadow:var(--shadow-sm)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

/* ───── Status Messages ───── */
.status-msg{padding:var(--sp-3) var(--sp-4);border-radius:var(--radius-md);font-size:13px;margin-bottom:var(--sp-4);line-height:1.5;display:flex;align-items:flex-start;gap:var(--sp-2)}
.status-msg svg{flex-shrink:0;margin-top:1px}
.status-info{background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.2);color:var(--info)}
.status-error{background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.2);color:var(--danger)}
.status-success{background:rgba(22,163,74,.06);border:1px solid rgba(22,163,74,.2);color:var(--accent)}
.status-warning{background:rgba(217,119,6,.06);border:1px solid rgba(217,119,6,.2);color:var(--warning)}
.loading{display:flex;align-items:center;gap:var(--sp-3);color:var(--text-secondary);font-size:14px}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ───── Divider ───── */
.divider{height:1px;background:var(--border);margin:var(--sp-6) 0;border:none}

/* ───── Results ───── */
.results{animation:fadeIn var(--duration-slow) var(--ease-out)}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* ───── Cards ───── */
.result-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--sp-4);margin-bottom:var(--sp-3);transition:all var(--duration-normal) var(--ease-out);animation:slideUp var(--duration-slow) var(--ease-out) both;box-shadow:var(--shadow-sm)}
.result-card:nth-child(1){animation-delay:0ms}
.result-card:nth-child(2){animation-delay:60ms}
.result-card:nth-child(3){animation-delay:120ms}
.result-card:nth-child(4){animation-delay:180ms}
.result-card:nth-child(5){animation-delay:240ms}
.result-card:nth-child(6){animation-delay:300ms}
.result-card:nth-child(7){animation-delay:360ms}
.result-card:nth-child(8){animation-delay:420ms}
.result-card:hover{border-color:var(--border-focus);transform:translateY(-2px);box-shadow:var(--shadow-md)}

.result-header{display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-2)}
.result-header svg{color:var(--text-secondary);flex-shrink:0}
.result-card h3{font-size:11px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin:0}
.result-value{font-size:28px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace}
.result-value .unit{font-size:14px;color:var(--text-secondary);font-weight:400;margin-left:var(--sp-1)}
.result-sub{font-size:13px;color:var(--text-secondary);margin-top:var(--sp-1)}
.result-badge{display:inline-block;padding:2px 8px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace}
.result-badge-danger{background:rgba(220,38,38,.08);color:var(--danger)}
.result-badge-success{background:rgba(22,163,74,.08);color:var(--accent)}

.result-highlight{border-color:rgba(220,38,38,.3);background:rgba(220,38,38,.03)}
.result-highlight .result-value{color:var(--danger)}
.result-positive{border-color:rgba(22,163,74,.3);background:rgba(22,163,74,.03)}
.result-positive .result-value{color:var(--accent)}

/* ───── Legend ───── */
.legend{margin-top:var(--sp-6)}
.legend-title{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:var(--sp-2);font-family:'JetBrains Mono',monospace}
.legend-item{display:flex;align-items:center;gap:var(--sp-3);margin-bottom:var(--sp-2);font-size:13px;color:var(--text-secondary)}
.legend-swatch{width:20px;height:14px;border-radius:3px;border:2px solid;flex-shrink:0}

/* ───── Water Details ───── */
.water-details{margin-top:var(--sp-3);list-style:none}
.water-row{display:flex;align-items:center;padding:var(--sp-2) var(--sp-2);border-bottom:1px solid var(--border);font-size:13px;border-radius:var(--radius-sm);margin:0 calc(-1 * var(--sp-2));transition:background var(--duration-fast) var(--ease-out);cursor:default}
.water-row:hover{background:rgba(37,99,235,.05)}
.water-row:last-child{border-bottom:none}
.water-name{color:var(--water-light);flex:1}
.water-badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(37,99,235,.08);color:var(--water-light);font-size:11px;font-weight:700;margin-right:var(--sp-2);flex-shrink:0}

/* ───── Map ───── */
#map{width:100%;height:100%;min-height:400px;background:#f2efe9}
.leaflet-container{background:#f2efe9;font-family:'Plus Jakarta Sans',sans-serif}

/* ───── Leaflet Controls ───── */
.leaflet-control-zoom a{background:var(--bg-elevated) !important;color:var(--text-primary) !important;border-color:var(--border) !important;transition:all var(--duration-fast) var(--ease-out)}
.leaflet-control-zoom a:hover{background:var(--bg-surface) !important;color:var(--accent) !important}
.leaflet-control-zoom{border:1px solid var(--border) !important;border-radius:var(--radius-md) !important;overflow:hidden;box-shadow:var(--shadow-md) !important}
.leaflet-control-attribution{background:rgba(255,255,255,.85) !important;color:var(--text-muted) !important;font-size:10px !important;backdrop-filter:blur(8px)}
.leaflet-control-attribution a{color:var(--text-secondary) !important}

/* ───── Leaflet Popup ───── */
.leaflet-popup-content-wrapper{background:var(--bg-elevated);color:var(--text-primary);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);border:1px solid var(--border)}
.leaflet-popup-tip{background:var(--bg-elevated);border:1px solid var(--border);border-top:none;border-left:none}
.leaflet-popup-content{font-size:13px;line-height:1.5;margin:12px 16px}
.leaflet-popup-close-button{color:var(--text-secondary) !important;font-size:18px !important}
.leaflet-popup-close-button:hover{color:var(--text-primary) !important}

/* ───── Mobile Bottom Sheet ───── */
@media(max-width:900px){
  .layout{grid-template-columns:1fr;grid-template-rows:1fr;position:relative;overflow:hidden}
  #map{position:fixed;inset:0;z-index:1;min-height:unset}
  .sidebar{
    position:fixed;bottom:0;left:0;right:0;z-index:10;
    max-height:85vh;
    border-right:none;border-top:1px solid var(--border);
    border-radius:var(--radius-lg) var(--radius-lg) 0 0;
    background:var(--bg-base);
    transform:translateY(calc(100% - var(--sheet-peek)));
    transition:transform var(--duration-slow) var(--ease-out);
    overscroll-behavior:contain;
    box-shadow:0 -4px 24px rgba(0,0,0,.1);
    padding-top:0;
  }
  .sidebar.sheet-open{transform:translateY(0)}
  .sheet-handle{
    display:flex;align-items:center;justify-content:center;
    padding:var(--sp-3) 0 var(--sp-2);cursor:grab;
    position:sticky;top:0;z-index:2;
    background:linear-gradient(180deg,var(--bg-base),transparent);
  }
  .sheet-handle::after{
    content:'';display:block;width:40px;height:4px;
    background:var(--text-muted);border-radius:2px;opacity:.4;
  }
  .sheet-chevron{color:var(--text-muted);transition:transform .25s var(--ease-out)}
  .sheet-open .sheet-chevron{transform:rotate(180deg)}
  h1{font-size:20px}
  .result-value{font-size:24px}
  .leaflet-control-zoom a{width:36px !important;height:36px !important;line-height:36px !important;font-size:18px !important}
  #mapEmptyState{left:50% !important;top:40% !important}
}
@media(min-width:901px){
  .sheet-handle{display:none}
}
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Põllu Piirangute Kalkulaator",
  "description": "Põllumassiivi taimekaitse piirangute kalkulaator. Arvutab veekaitsevööndi, mittepõllumajandusliku maa ja elanike puhvervööndid vastavalt SPe3 nõuetele.",
  "url": "https://veekaitse-arvutaja.vercel.app/",
  "inLanguage": "et",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Any",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "EUR"
  },
  "author": {
    "@type": "Person",
    "name": "Rain Villemson"
  }
}
</script>
</head>
<body>
<noscript><p style="padding:2rem;text-align:center;color:#1a1a2e;background:#f4f6f8">See rakendus vajab JavaScripti. Palun luba JavaScript oma brauseris.</p></noscript>
<main class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sheet-handle" id="sheetHandle">
      <svg class="sheet-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
    </div>
    <header>
      <p class="logo">PRIA × Keskkonnaamet</p>
      <h1>Põllu Piirangute Kalkulaator</h1>
      <p class="subtitle">Arvuta põllumassiivi taimekaitse piirangualad — veekaitsevööndid, mittepõllumajandusliku maa puhvrid ja muud SPe3 nõuded.</p>
    </header>

    <form id="searchForm" onsubmit="event.preventDefault();doSearch()">
      <div class="input-group">
        <label for="fieldNumber">Põllumassiivi number</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></span>
          <input type="text" id="fieldNumber" placeholder="nt. 67350880620" aria-describedby="fieldHint"/>
        </div>
        <p class="info-note" id="fieldHint">PRIA põllumassiivi registri number</p>
      </div>

      <div class="input-group">
        <label for="bufferWater">Veekogu puhver (m)</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg></span>
          <input type="number" id="bufferWater" value="10" min="0" step="0.5" aria-describedby="bufferWaterHint"/>
        </div>
        <p class="info-note" id="bufferWaterHint">Kaugus veekaitsevööndist (SPe3 veeorganismid)</p>
      </div>

      <div class="input-group">
        <label for="bufferEdge">Põlluserva puhver (m)</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 3v18"/></svg></span>
          <input type="number" id="bufferEdge" value="5" min="0" step="0.5" aria-describedby="bufferEdgeHint"/>
        </div>
        <p class="info-note" id="bufferEdgeHint">SPe3 mittesihtmärktaimed — kaugus mittepõllumajanduslikust maast (mets, tee, kraav). Ei rakendu seal kus kõrval on teine põld.</p>
      </div>

      <div class="input-group">
        <label for="bufferResidential">Elanike puhver (m)</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l7-4 7 4v14"/><path d="M9 21v-6h6v6"/></svg></span>
          <input type="number" id="bufferResidential" value="0" min="0" step="0.5" aria-describedby="bufferResidentialHint"/>
        </div>
        <p class="info-note" id="bufferResidentialHint">Kaugus elamurajoonidest ja avalikest kohtadest (SPe3 kõrvalised isikud). Jäta 0 kui ei kohaldu.</p>
      </div>

      <button class="btn btn-primary" type="submit" id="searchBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        Otsi ja arvuta
      </button>
    </form>

    <div style="text-align:center;margin-top:var(--sp-3)">
      <a href="#" id="demoLink" style="font-size:12px;color:var(--text-muted);text-decoration:none;border-bottom:1px dashed var(--text-muted);transition:color .15s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'" onclick="event.preventDefault();document.getElementById('fieldNumber').value='67350880620';doSearch()">Proovi näitega (67350880620)</a>
    </div>
    <div id="statusArea" role="status" aria-live="polite" style="margin-top:var(--sp-4)"></div>
    <div id="resultsArea"></div>

    <section class="legend" id="legendArea" aria-label="Kaardi selgitus" style="display:none">
      <hr class="divider">
      <h2 class="legend-title">Selgitus</h2>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(34,197,94,.18);border-color:#1b8a5a"></span>Põllumassiiv</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(134,239,172,.1);border-color:#86efac"></span>Naabermassivid (puhvrit ei rakendata)</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(156,163,175,.12);border-color:#9ca3af"></span>Mittepõllumajanduslik maa</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(59,130,246,.15);border-color:#2563a8"></span>Veekaitsevöönd</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(196,62,62,.3);border-color:#c43e3e"></span>Veekaitse kattuvus</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(124,58,237,.25);border-color:#7c3aed"></span>Põlluserva puhver (mittepm maa)</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(234,88,12,.25);border-color:#ea580c"></span>Elanike puhver</div>
    </section>
  </aside>
  <div id="map"></div>
  <div id="mapEmptyState" style="position:fixed;top:50%;left:calc(420px + (100% - 420px)/2);transform:translate(-50%,-50%);z-index:5;pointer-events:none;text-align:center;opacity:.5">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-muted);margin-bottom:8px"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    <p style="font-size:14px;color:var(--text-muted);font-family:'Plus Jakarta Sans',sans-serif">Sisesta põllumassiivi number<br>ja vajuta "Otsi ja arvuta"</p>
  </div>
</main>

<script>
proj4.defs('EPSG:3301','+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

const map=L.map('map',{center:[58.8,25.5],zoom:7});
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap, © CARTO',maxZoom:19}).addTo(map);

const layers=L.layerGroup().addTo(map);

/* ───── Status icons ───── */
const statusIcons={
  info:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
  error:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6"/><path d="M9 9l6 6"/></svg>',
  success:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
  warning:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>'
};

function setStatus(m,t='info'){
  const el=document.getElementById('statusArea');
  if(t==='loading'){
    el.innerHTML=`<div class="loading"><div class="spinner"></div>${m}</div>`;
  }else{
    el.innerHTML=`<div class="status-msg status-${t}">${statusIcons[t]||''}<span>${m}</span></div>`;
  }
}

/* ───── Mobile bottom sheet logic ───── */
const sidebar=document.getElementById('sidebar');
const sheetHandle=document.getElementById('sheetHandle');

function isMobile(){return window.innerWidth<=900}

function openSheet(){
  sidebar.classList.add('sheet-open');
}
function closeSheet(){
  sidebar.classList.remove('sheet-open');
}
function toggleSheet(){
  if(sidebar.classList.contains('sheet-open'))closeSheet();
  else openSheet();
}

sheetHandle.addEventListener('click',toggleSheet);

/* Auto-open sheet when inputs are focused on mobile */
document.querySelectorAll('#searchForm input').forEach(input=>{
  input.addEventListener('focus',()=>{
    if(isMobile()&&!sidebar.classList.contains('sheet-open'))openSheet();
  });
});

/* Touch drag for sheet handle */
let sheetStartY=0,sheetStartTransform=0,sheetDragging=false,sheetPeek=260;
sheetHandle.addEventListener('touchstart',e=>{
  if(!isMobile())return;
  sheetDragging=true;
  sheetStartY=e.touches[0].clientY;
  sheetPeek=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sheet-peek'))||260;
  sidebar.style.transition='none';
},{passive:true});
document.addEventListener('touchmove',e=>{
  if(!sheetDragging)return;
  const dy=e.touches[0].clientY-sheetStartY;
  const isOpen=sidebar.classList.contains('sheet-open');
  const base=isOpen?0:sidebar.offsetHeight-sheetPeek;
  const y=Math.max(0,Math.min(sidebar.offsetHeight-sheetPeek,base+dy));
  sidebar.style.transform=`translateY(${y}px)`;
},{passive:true});
document.addEventListener('touchend',()=>{
  if(!sheetDragging)return;
  sheetDragging=false;
  sidebar.style.transition='';
  const current=new DOMMatrix(getComputedStyle(sidebar).transform).m42;
  const threshold=sidebar.offsetHeight*0.4;
  if(current>threshold){sidebar.style.transform='';closeSheet()}
  else{sidebar.style.transform='';openSheet()}
});

/* Invalidate map size on resize (bottom sheet can obscure) */
window.addEventListener('resize',()=>{setTimeout(()=>map.invalidateSize(),100)});

/* ───── Coordinate helpers ───── */
const c2w=c=>proj4('EPSG:3301','EPSG:4326',[c[0],c[1]]);
const c2e=c=>proj4('EPSG:4326','EPSG:3301',[c[0],c[1]]);

function mapCoords(coords,type,fn){
  if(type==='Polygon')return coords.map(r=>r.map(fn));
  if(type==='MultiPolygon')return coords.map(p=>p.map(r=>r.map(fn)));
  return coords;
}

function calcArea(geojson){
  try{
    const g=geojson.geometry||geojson;
    const pc=mapCoords(g.coordinates,g.type,c2e);
    let total=0;
    const ra=ring=>{let a=0;for(let j=0;j<ring.length-1;j++){a+=ring[j][0]*ring[j+1][1]-ring[j+1][0]*ring[j][1]}return Math.abs(a)/2};
    if(g.type==='Polygon')pc.forEach((r,i)=>total+=(i===0?1:-1)*ra(r));
    else if(g.type==='MultiPolygon')pc.forEach(p=>p.forEach((r,i)=>total+=(i===0?1:-1)*ra(r)));
    return Math.abs(total);
  }catch(e){return turf.area(geojson)}
}

function getBBox(f){
  const c=f.geometry.coordinates;let all=[];
  if(f.geometry.type==='Polygon')all=c[0];else c.forEach(p=>all.push(...p[0]));
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  all.forEach(c=>{x1=Math.min(x1,c[0]);y1=Math.min(y1,c[1]);x2=Math.max(x2,c[0]);y2=Math.max(y2,c[1])});
  return[x1-500,y1-500,x2+500,y2+500];
}

function toWGS(f){
  const g=f.geometry;
  return{type:'Feature',properties:f.properties||{},geometry:{type:g.type,coordinates:mapCoords(g.coordinates,g.type,c2w)}};
}

/* ───── Result card icons ───── */
const cardIcons={
  field:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>',
  area:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>',
  danger:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
  usable:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
  water:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg>',
  nonAgri:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 3v18"/></svg>',
  building:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l7-4 7 4v14"/><path d="M9 21v-6h6v6"/></svg>',
  total:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>'
};

/* ───── Estonian number formatting ───── */
function fmtNum(n,dec=4){
  const parts=n.toFixed(dec).split('.');
  parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
  return parts.join(',');
}
function fmtInt(n){return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ')}

/* ───── Helper: safe union of feature array ───── */
function safeUnion(features){
  if(!features.length)return null;
  let merged=features[0];
  for(let i=1;i<features.length;i++){try{merged=turf.union(merged,features[i])}catch(e){}}
  return merged;
}

async function doSearch(){
  const num=document.getElementById('fieldNumber').value.trim();
  const bufWater=parseFloat(document.getElementById('bufferWater').value)||0;
  const bufEdge=parseFloat(document.getElementById('bufferEdge').value)||0;
  const bufResidential=parseFloat(document.getElementById('bufferResidential').value)||0;
  if(!num){setStatus('Palun sisesta põllumassiivi number','error');return}

  const btnHtml='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Otsi ja arvuta';
  const btn=document.getElementById('searchBtn');
  btn.disabled=true;
  btn.innerHTML='<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Otsin...';
  document.getElementById('resultsArea').innerHTML='';
  document.getElementById('legendArea').style.display='none';
  const emptyState=document.getElementById('mapEmptyState');
  if(emptyState)emptyState.style.display='none';
  layers.clearLayers();

  try{
    // 1. Põllumassiiv
    setStatus('Otsin põllumassiivi PRIA registrist...','loading');
    const fr=await fetch(`/api/field/${num}`);
    const fd=await fr.json();
    if(fd.error)throw new Error(fd.error);
    if(!fd.features||!fd.features.length)throw new Error(`Massiivi ${num} ei leitud PRIA registrist`);

    const ff=fd.features[0],fp=ff.properties,fw=toWGS(ff);
    const fl=L.geoJSON(fw,{style:{color:'#1b8a5a',fillColor:'#22c55e',fillOpacity:.18,weight:2.5}})
      .bindPopup(`<b>Massiiv ${num}</b><br>Pindala: ${fp.pindala?(fp.pindala/10000).toFixed(2)+' ha':'teadmata'}`);
    layers.addLayer(fl);
    map.fitBounds(fl.getBounds(),{padding:[60,60]});

    const bbox=getBBox(ff);
    let waterOverlapFeature=null,edgeStripFeature=null;
    let waterOverlapArea=0,edgeOverlapArea=0;
    let waterZonesWGS=[];
    let bufferedWaterZone=null;

    // ──── A) Veekogu puhver ────
    setStatus('Otsin veekaitsevööndeid...','loading');
    const wr=await fetch(`/api/water-zones?bbox=${bbox.join(',')}`);
    const wd=await wr.json();
    if(wd.error)throw new Error(wd.error);
    const wz=wd.features||[];
    waterZonesWGS=wz.map(toWGS);

    if(waterZonesWGS.length){
      setStatus(`Leitud ${waterZonesWGS.length} veekaitsevööndit. Arvutan...`,'loading');
      waterZonesWGS.forEach(w=>{
        const n=w.properties.objekti_nimetus||w.properties.voondi_nimetus||w.properties.nimi||'Veekaitsevöönd';
        layers.addLayer(L.geoJSON(w,{style:{color:'#2563a8',fillColor:'#3b82f6',fillOpacity:.15,weight:1.5,dashArray:'4 4'}}).bindPopup(`<b>${n}</b>`));
      });

      let merged=safeUnion(waterZonesWGS);
      bufferedWaterZone=merged;
      if(bufWater>0&&merged){
        try{
          bufferedWaterZone=turf.buffer(merged,bufWater/1000,{units:'kilometers'});
          // Joonista puhvri riba
          let bufferRing=null;
          try{bufferRing=turf.difference(bufferedWaterZone,merged)}catch(e){}
          if(bufferRing){
            layers.addLayer(L.geoJSON(bufferRing,{style:{color:'#2563a8',fillColor:'#3b82f6',fillOpacity:.1,weight:1,dashArray:'6 3'}}));
          }
        }catch(e){}
      }

      try{
        waterOverlapFeature=turf.intersect(fw,bufferedWaterZone);
        if(waterOverlapFeature){
          waterOverlapArea=calcArea(waterOverlapFeature);
          layers.addLayer(L.geoJSON(waterOverlapFeature,{style:{color:'#c43e3e',fillColor:'#c43e3e',fillOpacity:.3,weight:2}}).bindPopup(`<b>Veekaitse kattuvus</b><br>${fmtNum(waterOverlapArea/10000)} ha`));
        }
      }catch(e){
        for(const w of waterZonesWGS){
          try{
            const z=bufWater>0?turf.buffer(w,bufWater/1000,{units:'kilometers'}):w;
            const ix=turf.intersect(fw,z);
            if(ix){waterOverlapArea+=calcArea(ix);if(!waterOverlapFeature)waterOverlapFeature=ix;else try{waterOverlapFeature=turf.union(waterOverlapFeature,ix)}catch(e2){}}
          }catch(e2){}
        }
        if(waterOverlapFeature)layers.addLayer(L.geoJSON(waterOverlapFeature,{style:{color:'#c43e3e',fillColor:'#c43e3e',fillOpacity:.3,weight:2}}));
      }
    }

    // ──── B) Põlluserva puhver ────
    let neighborCount=0;
    if(bufEdge>0){
      setStatus('Otsin naabermassivide...','loading');

      const edgeExt=Math.max(bufEdge+500,1000);
      const edgeBbox3301=[bbox[0]-edgeExt,bbox[1]-edgeExt,bbox[2]+edgeExt,bbox[3]+edgeExt];

      const nfResp=await fetch(`/api/nearby-fields?bbox=${edgeBbox3301.join(',')}`);
      const nfData=await nfResp.json();
      const allRawFeatures=nfData.features||[];
      const allFieldFeatures=allRawFeatures.map(toWGS);

      function getFieldId(feature){
        const p=feature.properties||{};
        return p.massiivi_id||p.MASSIIVI_ID||p.massiiv_id||p.MASSIIV_ID||p.xy_id||p.XY_ID||p.id||p.ID||'';
      }
      const targetId=String(getFieldId(ff));

      let allAgriLand=null;
      for(let i=0;i<allFieldFeatures.length;i++){
        try{
          allAgriLand=allAgriLand?turf.union(allAgriLand,allFieldFeatures[i]):allFieldFeatures[i];
        }catch(e){}
      }

      if(allAgriLand){
        const fieldBounds=turf.bbox(fw);
        const expandDeg=0.015;
        const bboxPoly=turf.bboxPolygon([
          fieldBounds[0]-expandDeg,
          fieldBounds[1]-expandDeg*0.6,
          fieldBounds[2]+expandDeg,
          fieldBounds[3]+expandDeg*0.6
        ]);

        let nonAgriLand=null;
        try{nonAgriLand=turf.difference(bboxPoly,allAgriLand)}catch(e){}

        if(nonAgriLand){
          let nonAgriBuf=null;
          try{nonAgriBuf=turf.buffer(nonAgriLand,bufEdge/1000,{units:'kilometers'})}catch(e){}

          if(nonAgriBuf){
            let edgeOverlap=null;
            try{edgeOverlap=turf.intersect(fw,nonAgriBuf)}catch(e){}

            if(edgeOverlap){
              // Morfoloogiline sulgemine: eemalda kitsad vahed (<6m) massiivide vahel
              try{
                const eroded=turf.buffer(nonAgriLand,-0.003,{units:'kilometers'});
                if(eroded){
                  const dilated=turf.buffer(eroded,(bufEdge+3)/1000,{units:'kilometers'});
                  const cleanOverlap=turf.intersect(fw,dilated);
                  if(cleanOverlap)edgeOverlap=cleanOverlap;
                }
              }catch(e){}

              // Eemalda veekaitsevööndi kattuvus
              if(bufferedWaterZone){
                try{edgeOverlap=turf.difference(edgeOverlap,bufferedWaterZone)}catch(e){}
              }

              // Puhasta MultiPolygon killud
              if(edgeOverlap&&edgeOverlap.geometry.type==='MultiPolygon'){
                const valid=edgeOverlap.geometry.coordinates.filter(p=>{
                  try{return p[0]&&p[0].length>=4&&turf.area(turf.polygon(p))>1}catch(e){return false}
                });
                if(valid.length===0)edgeOverlap=null;
                else if(valid.length===1)edgeOverlap=turf.polygon(valid[0]);
                else edgeOverlap=turf.multiPolygon(valid);
              }

              if(edgeOverlap){
                edgeOverlapArea=calcArea(edgeOverlap);
                if(edgeOverlapArea<1)edgeOverlapArea=turf.area(edgeOverlap);

                if(edgeOverlapArea>1){
                  edgeStripFeature=edgeOverlap;
                  layers.addLayer(L.geoJSON(edgeOverlap,{
                    style:{color:'#7c3aed',fillColor:'#7c3aed',fillOpacity:.25,weight:2,opacity:.8}
                  }).bindPopup(`<b>Põlluserva puhver (${bufEdge}m)</b><br>${fmtNum(edgeOverlapArea/10000)} ha<br>Mittepõllumajanduslikust maast`));
                }
              }
            }
          }
        }

        // Naabermassivid kaardil
        const neighbors=allFieldFeatures.filter(f=>String(getFieldId(f))!==targetId&&String(getFieldId(f))!=='');
        neighborCount=neighbors.length;
        if(neighbors.length>0){
          let nUnion=neighbors[0];
          for(let i=1;i<neighbors.length;i++){try{nUnion=turf.union(nUnion,neighbors[i])}catch(e){}}
          layers.addLayer(L.geoJSON(nUnion,{
            style:{color:'#86efac',fillColor:'#86efac',fillOpacity:.05,weight:1,opacity:.3,dashArray:'3 3'}
          }).bindPopup(`Naabermassivid (${neighbors.length} tk)`));
        }
      }
    }

    // ──── C) Elanike puhver (informatiivne) ────
    let residentialNote='';
    if(bufResidential>0){
      residentialNote=`Elanike puhver ${bufResidential}m on seatud. Hoonete automaatne tuvastamine pole veel toetatud — kontrolli kohapeal kas massiivi läheduses on elamuid.`;
    }

    // ──── D) Koondtulemus ────
    setStatus('Arvutan koondtulemust...','loading');
    let allRestricted=null;
    if(waterOverlapFeature)allRestricted=waterOverlapFeature;
    if(edgeStripFeature){allRestricted=allRestricted?turf.union(allRestricted,edgeStripFeature):edgeStripFeature}
    const totalRestrictedArea=allRestricted?calcArea(allRestricted):0;

    setStatus(totalRestrictedArea>0
      ?`Vähendatav ala kokku: ${fmtNum(totalRestrictedArea/10000)} ha`
      :'Piirangualasid ei leitud.',
      totalRestrictedArea>0?'warning':'success');

    showResults(fw,fp,waterZonesWGS,waterOverlapArea,edgeOverlapArea,totalRestrictedArea,bufWater,bufEdge,bufResidential,neighborCount,residentialNote);
    document.getElementById('legendArea').style.display='block';

    if(isMobile())openSheet();

  }catch(err){
    console.error(err);
    setStatus(err.message||'Viga andmete laadimisel','error');
  }
  btn.disabled=false;
  btn.innerHTML=btnHtml;
}

function showResults(field,props,waterZones,waterArea,edgeArea,totalArea,bufWater,bufEdge,bufResidential,neighborCount,residentialNote){
  const fa=calcArea(field),fh=fmtNum(fa/10000);
  const th=fmtNum(totalArea/10000);
  const uh=fmtNum((fa-totalArea)/10000);
  const tp=fa>0?((totalArea/fa)*100).toFixed(1).replace('.',','):'0';

  let h='<hr class="divider"><section class="results" aria-label="Tulemused">';

  h+=`<article class="result-card"><header class="result-header">${cardIcons.field}<h3>Põllumassiiv</h3></header><p class="result-value">${props.xy_id||'N/A'}</p><p class="result-sub">${[props.maakond,props.vald].filter(Boolean).join(', ')}</p></article>`;

  h+=`<article class="result-card"><header class="result-header">${cardIcons.area}<h3>Massiivi pindala</h3></header><p class="result-value">${fh}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(fa)} m²</p></article>`;

  if(waterArea>0){
    h+=`<article class="result-card result-highlight"><header class="result-header">${cardIcons.water}<h3>Veekaitse puhver (${bufWater}m)</h3></header><p class="result-value" style="color:#c43e3e">${fmtNum(waterArea/10000)}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(waterArea)} m²</p></article>`;
  }else if(bufWater>0){
    h+=`<article class="result-card"><header class="result-header">${cardIcons.water}<h3>Veekaitse puhver (${bufWater}m)</h3></header><p class="result-value">0<span class="unit">ha</span></p><p class="result-sub">Veekaitsevööndeid ei leitud</p></article>`;
  }

  if(bufEdge>0){
    if(edgeArea>0){
      h+=`<article class="result-card" style="border-color:rgba(124,58,237,.3);background:rgba(124,58,237,.03)"><header class="result-header">${cardIcons.nonAgri}<h3>Põlluserva puhver (${bufEdge}m)</h3></header><p class="result-value" style="color:#7c3aed">${fmtNum(edgeArea/10000)}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(edgeArea)} m² · Arvestatud ${neighborCount} naabermassiviga. Servades kus kõrval on teine põld, puhvrit ei rakendata.</p></article>`;
    }else{
      h+=`<article class="result-card"><header class="result-header">${cardIcons.nonAgri}<h3>Põlluserva puhver (${bufEdge}m)</h3></header><p class="result-value">0<span class="unit">ha</span></p><p class="result-sub">Kogu massiivi serv piirneb teiste põldudega</p></article>`;
    }
  }

  if(bufResidential>0){
    h+=`<article class="result-card" style="border-color:rgba(234,88,12,.3);background:rgba(234,88,12,.03)"><header class="result-header">${cardIcons.building}<h3>Elanike puhver (${bufResidential}m)</h3></header><p class="result-value" style="color:#ea580c">—</p><p class="result-sub">${residentialNote}</p></article>`;
  }

  h+=`<article class="result-card ${totalArea>0?'result-highlight':''}"><header class="result-header">${cardIcons.total}<h3>Kokku vähendatav</h3></header><p class="result-value">${th}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(totalArea)} m² · <span class="result-badge ${totalArea>0?'result-badge-danger':'result-badge-success'}">${tp}%</span> massiivi pindalast</p></article>`;

  if(totalArea>0){
    h+=`<article class="result-card result-positive"><header class="result-header">${cardIcons.usable}<h3>Kasutatav pindala</h3></header><p class="result-value">${uh}<span class="unit">ha</span></p><p class="result-sub">Massiivi pindala miinus kogu vähendatav ala</p></article>`;
  }

  if(waterZones.length){
    h+=`<article class="result-card"><header class="result-header">${cardIcons.water}<h3>Leitud veekaitsevööndid</h3><span class="result-badge result-badge-success">${waterZones.length}</span></header><ul class="water-details">`;
    waterZones.forEach((w,i)=>{
      const name=w.properties.objekti_nimetus||w.properties.voondi_nimetus||w.properties.nimi||'Nimeta';
      h+=`<li class="water-row"><span class="water-badge">${i+1}</span><span class="water-name">${name}</span></li>`;
    });
    h+='</ul></article>';
  }

  h+='</section>';
  document.getElementById('resultsArea').innerHTML=h;
}
</script>
</body>
</html>
