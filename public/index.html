<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Veekaitsevööndi kalkulaator | Põllumassiivi ja veekaitsevööndi kattuvuse arvutaja</title>
<meta name="description" content="Arvuta põllumassiivi ja veekaitsevööndite kattuvus interaktiivsel kaardil. Kasuta PRIA registri andmeid ja Keskkonnaameti veekaitsevööndeid, et leida piirangualad ja puhvertsoonid.">
<meta name="keywords" content="veekaitsevöönd, kalkulaator, põllumassiiv, PRIA, Keskkonnaamet, veekaitsevööndi arvutaja, põllumajandus, veekaitse, puhverala, kattuvus, Eesti, maaregister">
<meta name="author" content="Rain Villemson">
<meta name="theme-color" content="#141f1a">
<link rel="canonical" href="https://veekaitse-arvutaja.vercel.app/">
<meta property="og:type" content="website">
<meta property="og:title" content="Veekaitsevööndi kalkulaator">
<meta property="og:description" content="Arvuta põllumassiivi ja veekaitsevööndite kattuvus interaktiivsel kaardil. PRIA ja Keskkonnaameti andmed.">
<meta property="og:url" content="https://veekaitse-arvutaja.vercel.app/">
<meta property="og:locale" content="et_EE">
<meta property="og:site_name" content="Veekaitsevööndi kalkulaator">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Veekaitsevööndi kalkulaator">
<meta name="twitter:description" content="Arvuta põllumassiivi ja veekaitsevööndite kattuvus interaktiivsel kaardil.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ───── 1. CSS Variables ───── */
:root{
  /* Backgrounds */
  --bg-base:#141f1a;--bg-surface:#1a2b22;--bg-elevated:#213a2c;
  /* Text */
  --text-primary:#e8f5e8;--text-secondary:#8faa8f;--text-muted:#5e7a5e;
  /* Accents */
  --accent:#5cb85c;--accent-bright:#7dd87d;--accent-glow:rgba(92,184,92,.2);
  --danger:#d9534f;--warning:#f0ad4e;--info:#5a9bf5;--water:#3a7bd5;--water-light:#5a9bf5;
  /* Borders */
  --border:#2a4a2a;--border-focus:#4a8a4a;
  /* Spacing scale */
  --sp-1:4px;--sp-2:8px;--sp-3:12px;--sp-4:16px;--sp-5:20px;--sp-6:24px;--sp-7:28px;--sp-8:32px;--sp-9:36px;--sp-10:40px;
  /* Radius */
  --radius-sm:6px;--radius-md:10px;--radius-lg:16px;
  /* Shadows */
  --shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 12px rgba(0,0,0,.4);--shadow-lg:0 8px 32px rgba(0,0,0,.5);
  /* Animation */
  --ease-out:cubic-bezier(.2,0,.38,.9);--duration-fast:.15s;--duration-normal:.25s;--duration-slow:.4s;
}
/* ───── Reset & Typography ───── */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg-base);color:var(--text-primary);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.5}

/* ───── Focus & Accessibility ───── */
:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:var(--radius-sm)}
:focus:not(:focus-visible){outline:none}

/* ───── Scrollbar ───── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-focus)}
*{scrollbar-width:thin;scrollbar-color:var(--border) transparent}

/* ───── Layout: Desktop ───── */
.layout{display:grid;grid-template-columns:420px 1fr;min-height:100vh}

/* ───── Sidebar ───── */
.sidebar{padding:var(--sp-7) var(--sp-6);border-right:1px solid var(--border);overflow-y:auto;background:linear-gradient(180deg,var(--bg-base),#0f1a14)}
.logo{font-family:'Space Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:var(--sp-1)}
h1{font-size:24px;font-weight:700;color:var(--text-primary);margin-bottom:var(--sp-1);line-height:1.3}
.subtitle{font-size:13px;color:var(--text-secondary);margin-bottom:var(--sp-7);line-height:1.6}

/* ───── Inputs ───── */
.input-group{margin-bottom:var(--sp-5)}
label{display:block;font-size:11px;font-weight:500;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:var(--sp-2);font-family:'Space Mono',monospace}
.input-wrapper{position:relative;display:flex;align-items:center}
.input-icon{position:absolute;left:var(--sp-3);color:var(--text-muted);pointer-events:none;display:flex;align-items:center;transition:color var(--duration-fast) var(--ease-out)}
.input-wrapper:focus-within .input-icon{color:var(--accent)}
input[type="text"],input[type="number"]{width:100%;padding:var(--sp-3) var(--sp-4) var(--sp-3) 40px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-size:16px;font-family:'DM Sans',sans-serif;transition:all var(--duration-normal) var(--ease-out);outline:none;min-height:48px}
input:focus{border-color:var(--border-focus);background:var(--bg-elevated);box-shadow:0 0 0 3px var(--accent-glow)}
input::placeholder{color:var(--text-muted);opacity:.7;transition:opacity var(--duration-fast) var(--ease-out)}
input:focus::placeholder{opacity:.4}
.info-note{font-size:12px;color:var(--text-muted);margin-top:var(--sp-1);line-height:1.4}

/* ───── Button ───── */
.btn{width:100%;padding:var(--sp-3) var(--sp-5);border:none;border-radius:var(--radius-md);font-size:15px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all var(--duration-normal) var(--ease-out);min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-2)}
.btn-primary{background:linear-gradient(135deg,#4da84d,#6bc76b);color:#0a1a0a;box-shadow:var(--shadow-sm)}
.btn-primary:hover{background:linear-gradient(135deg,#5cb85c,#7dd87d);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.btn-primary:active{transform:scale(.98);box-shadow:var(--shadow-sm)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

/* ───── Status Messages ───── */
.status-msg{padding:var(--sp-3) var(--sp-4);border-radius:var(--radius-md);font-size:13px;margin-bottom:var(--sp-4);line-height:1.5;display:flex;align-items:flex-start;gap:var(--sp-2)}
.status-msg svg{flex-shrink:0;margin-top:1px}
.status-info{background:rgba(58,123,213,.1);border:1px solid rgba(58,123,213,.25);color:var(--water-light)}
.status-error{background:rgba(217,83,79,.1);border:1px solid rgba(217,83,79,.25);color:#f08080}
.status-success{background:rgba(92,184,92,.1);border:1px solid rgba(92,184,92,.25);color:var(--accent-bright)}
.status-warning{background:rgba(240,173,78,.1);border:1px solid rgba(240,173,78,.25);color:var(--warning)}
.loading{display:flex;align-items:center;gap:var(--sp-3);color:var(--text-secondary);font-size:14px}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ───── Divider ───── */
.divider{height:1px;background:var(--border);margin:var(--sp-6) 0;border:none}

/* ───── Results ───── */
.results{animation:fadeIn var(--duration-slow) var(--ease-out)}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* ───── Glassmorphism Cards ───── */
.result-card{background:rgba(26,43,34,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--sp-4);margin-bottom:var(--sp-3);transition:all var(--duration-normal) var(--ease-out);animation:slideUp var(--duration-slow) var(--ease-out) both}
.result-card:nth-child(1){animation-delay:0ms}
.result-card:nth-child(2){animation-delay:60ms}
.result-card:nth-child(3){animation-delay:120ms}
.result-card:nth-child(4){animation-delay:180ms}
.result-card:nth-child(5){animation-delay:240ms}
.result-card:hover{border-color:var(--border-focus);transform:translateY(-2px);box-shadow:var(--shadow-md)}

.result-header{display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-2)}
.result-header svg{color:var(--text-secondary);flex-shrink:0}
.result-card h3{font-size:11px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin:0}
.result-value{font-size:28px;font-weight:700;color:var(--text-primary);font-family:'Space Mono',monospace}
.result-value .unit{font-size:14px;color:var(--text-secondary);font-weight:400;margin-left:var(--sp-1)}
.result-sub{font-size:13px;color:var(--text-secondary);margin-top:var(--sp-1)}
.result-badge{display:inline-block;padding:2px 8px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;font-family:'Space Mono',monospace}
.result-badge-danger{background:rgba(217,83,79,.15);color:var(--danger)}
.result-badge-success{background:rgba(92,184,92,.15);color:var(--accent-bright)}

.result-highlight{border-color:var(--danger);background:rgba(217,83,79,.06)}
.result-highlight .result-value{color:var(--danger)}
.result-positive{border-color:var(--accent);background:rgba(92,184,92,.06)}
.result-positive .result-value{color:var(--accent-bright)}

/* ───── Legend ───── */
.legend{margin-top:var(--sp-6)}
.legend-title{display:block;font-size:11px;font-weight:500;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:var(--sp-2);font-family:'Space Mono',monospace}
.legend-item{display:flex;align-items:center;gap:var(--sp-3);margin-bottom:var(--sp-2);font-size:13px;color:var(--text-secondary)}
.legend-swatch{width:20px;height:14px;border-radius:3px;border:2px solid;flex-shrink:0}

/* ───── Water Details ───── */
.water-details{margin-top:var(--sp-3);list-style:none}
.water-row{display:flex;align-items:center;padding:var(--sp-2) var(--sp-2);border-bottom:1px solid rgba(42,74,42,.5);font-size:13px;border-radius:var(--radius-sm);margin:0 calc(-1 * var(--sp-2));transition:background var(--duration-fast) var(--ease-out);cursor:default}
.water-row:hover{background:rgba(58,123,213,.08)}
.water-row:last-child{border-bottom:none}
.water-name{color:var(--water-light);flex:1}
.water-badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(58,123,213,.15);color:var(--water-light);font-size:11px;font-weight:700;margin-right:var(--sp-2);flex-shrink:0}

/* ───── Map ───── */
#map{width:100%;height:100%;min-height:400px;background:#0a120a}
.leaflet-container{background:#0a120a;font-family:'DM Sans',sans-serif}

/* ───── Leaflet Controls: Dark Theme ───── */
.leaflet-control-zoom a{background:var(--bg-surface) !important;color:var(--text-primary) !important;border-color:var(--border) !important;transition:all var(--duration-fast) var(--ease-out)}
.leaflet-control-zoom a:hover{background:var(--bg-elevated) !important;color:var(--accent-bright) !important}
.leaflet-control-zoom{border:1px solid var(--border) !important;border-radius:var(--radius-md) !important;overflow:hidden;box-shadow:var(--shadow-md) !important}
.leaflet-control-attribution{background:rgba(20,31,26,.85) !important;color:var(--text-muted) !important;font-size:10px !important;backdrop-filter:blur(8px)}
.leaflet-control-attribution a{color:var(--text-secondary) !important}

/* ───── Leaflet Popup: Dark Theme ───── */
.leaflet-popup-content-wrapper{background:var(--bg-surface);color:var(--text-primary);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);border:1px solid var(--border)}
.leaflet-popup-tip{background:var(--bg-surface);border:1px solid var(--border);border-top:none;border-left:none}
.leaflet-popup-content{font-size:13px;line-height:1.5;margin:12px 16px}
.leaflet-popup-close-button{color:var(--text-secondary) !important;font-size:18px !important}
.leaflet-popup-close-button:hover{color:var(--text-primary) !important}

/* ───── Mobile Bottom Sheet ───── */
@media(max-width:900px){
  .layout{grid-template-columns:1fr;grid-template-rows:1fr;position:relative;overflow:hidden}
  #map{position:fixed;inset:0;z-index:1;min-height:unset}
  .sidebar{
    position:fixed;bottom:0;left:0;right:0;z-index:10;
    max-height:85vh;
    border-right:none;border-top:1px solid var(--border);
    border-radius:var(--radius-lg) var(--radius-lg) 0 0;
    background:linear-gradient(180deg,var(--bg-base),#0f1a14);
    transform:translateY(calc(100% - 60px));
    transition:transform var(--duration-slow) var(--ease-out);
    overscroll-behavior:contain;
    box-shadow:0 -4px 24px rgba(0,0,0,.4);
    padding-top:0;
  }
  .sidebar.sheet-open{transform:translateY(0)}
  .sheet-handle{
    display:flex;align-items:center;justify-content:center;
    padding:var(--sp-3) 0 var(--sp-2);cursor:grab;
    position:sticky;top:0;z-index:2;
    background:linear-gradient(180deg,var(--bg-base),transparent);
  }
  .sheet-handle::after{
    content:'';display:block;width:40px;height:4px;
    background:var(--text-muted);border-radius:2px;opacity:.6;
  }
  .sheet-toggle{
    position:fixed;bottom:76px;right:var(--sp-4);z-index:9;
    width:52px;height:52px;border-radius:50%;border:none;
    background:linear-gradient(135deg,#4da84d,#6bc76b);
    color:#0a1a0a;cursor:pointer;
    box-shadow:var(--shadow-lg);
    display:flex;align-items:center;justify-content:center;
    transition:all var(--duration-normal) var(--ease-out);
  }
  .sheet-toggle:active{transform:scale(.92)}
  .sheet-toggle.hidden{opacity:0;pointer-events:none;transform:scale(.5)}
  h1{font-size:20px}
  .result-value{font-size:24px}
  .leaflet-control-zoom a{width:36px !important;height:36px !important;line-height:36px !important;font-size:18px !important}
  #mapEmptyState{left:50% !important;top:40% !important}
}
@media(min-width:901px){
  .sheet-handle{display:none}
  .sheet-toggle{display:none}
}
</style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Veekaitsevööndi kalkulaator",
  "description": "Arvuta põllumassiivi ja veekaitsevööndite kattuvus interaktiivsel kaardil. Kasuta PRIA registri andmeid ja Keskkonnaameti veekaitsevööndeid.",
  "url": "https://veekaitse-arvutaja.vercel.app/",
  "inLanguage": "et",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Any",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "EUR"
  },
  "author": {
    "@type": "Person",
    "name": "Rain Villemson"
  }
}
</script>
</head>
<body>
<noscript><p style="padding:2rem;text-align:center;color:#e8f5e8;background:#141f1a">See rakendus vajab JavaScripti. Palun luba JavaScript oma brauseris.</p></noscript>
<main class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sheet-handle" id="sheetHandle"></div>
    <header>
      <p class="logo">PRIA × Keskkonnaamet</p>
      <h1>Veekaitsevööndi kalkulaator</h1>
      <p class="subtitle">Leia põllumassiivi ja veekaitsevööndite kattuvus ning arvuta puhverala pindala.</p>
    </header>

    <form id="searchForm" onsubmit="event.preventDefault();search()">
      <div class="input-group">
        <label for="fieldNumber">Põllumassiivi number</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></span>
          <input type="text" id="fieldNumber" placeholder="nt. 67350880620" aria-describedby="fieldHint"/>
        </div>
        <p class="info-note" id="fieldHint">PRIA põllumassiivi registri number</p>
      </div>

      <div class="input-group">
        <label for="bufferDistance">Puhvervahemaa (meetrites)</label>
        <div class="input-wrapper">
          <span class="input-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg></span>
          <input type="number" id="bufferDistance" value="1" min="0" step="0.5" aria-describedby="bufferHint"/>
        </div>
        <p class="info-note" id="bufferHint">Kui palju meetreid peab veekaitsealast eemale jääma</p>
      </div>

      <button class="btn btn-primary" type="submit" id="searchBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        Otsi ja arvuta
      </button>
    </form>

    <div style="text-align:center;margin-top:var(--sp-3)">
      <a href="#" id="demoLink" style="font-size:12px;color:var(--text-muted);text-decoration:none;border-bottom:1px dashed var(--text-muted);transition:color .15s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'" onclick="event.preventDefault();document.getElementById('fieldNumber').value='67350880620';search()">Proovi näitega (67350880620)</a>
    </div>
    <div id="statusArea" role="status" aria-live="polite" style="margin-top:var(--sp-4)"></div>
    <div id="resultsArea"></div>

    <section class="legend" id="legendArea" aria-label="Kaardi selgitus" style="display:none">
      <hr class="divider">
      <h2 class="legend-title">Selgitus</h2>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(92,184,92,.3);border-color:#5cb85c"></span>Põllumassiiv</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(58,123,213,.25);border-color:#3a7bd5"></span>Veekaitsevöönd</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(240,173,78,.3);border-color:#f0ad4e"></span>Puhverala (veekaitsevöönd + puhver)</div>
      <div class="legend-item"><span class="legend-swatch" style="background:rgba(217,83,79,.4);border-color:#d9534f"></span>Vähendatav ala</div>
    </section>
  </aside>
  <div id="map"></div>
  <div id="mapEmptyState" style="position:fixed;top:50%;left:calc(420px + (100% - 420px)/2);transform:translate(-50%,-50%);z-index:5;pointer-events:none;text-align:center;opacity:.5">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-muted);margin-bottom:8px"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    <p style="font-size:14px;color:var(--text-muted);font-family:'DM Sans',sans-serif">Sisesta põllumassiivi number<br>ja vajuta "Otsi ja arvuta"</p>
  </div>
</main>

<!-- Mobile sheet toggle FAB -->
<button class="sheet-toggle" id="sheetToggle" aria-label="Ava paneel">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
</button>

<script>
proj4.defs('EPSG:3301','+proj=lcc +lat_1=59.33333333333334 +lat_2=58 +lat_0=57.51755393055556 +lon_0=24 +x_0=500000 +y_0=6375000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

const map=L.map('map',{center:[58.8,25.5],zoom:7});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap, © CARTO',maxZoom:19}).addTo(map);

const layers=L.layerGroup().addTo(map);

/* ───── Status icons ───── */
const statusIcons={
  info:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
  error:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6"/><path d="M9 9l6 6"/></svg>',
  success:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
  warning:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>'
};

function setStatus(m,t='info'){
  const el=document.getElementById('statusArea');
  if(t==='loading'){
    el.innerHTML=`<div class="loading"><div class="spinner"></div>${m}</div>`;
  }else{
    el.innerHTML=`<div class="status-msg status-${t}">${statusIcons[t]||''}<span>${m}</span></div>`;
  }
}

/* ───── Mobile bottom sheet logic ───── */
const sidebar=document.getElementById('sidebar');
const sheetToggle=document.getElementById('sheetToggle');
const sheetHandle=document.getElementById('sheetHandle');

function isMobile(){return window.innerWidth<=900}

function openSheet(){
  sidebar.classList.add('sheet-open');
  sheetToggle.classList.add('hidden');
}
function closeSheet(){
  sidebar.classList.remove('sheet-open');
  sheetToggle.classList.remove('hidden');
}
function toggleSheet(){
  if(sidebar.classList.contains('sheet-open'))closeSheet();
  else openSheet();
}

sheetToggle.addEventListener('click',toggleSheet);
sheetHandle.addEventListener('click',toggleSheet);

/* Touch drag for sheet handle */
let sheetStartY=0,sheetStartTransform=0,sheetDragging=false;
sheetHandle.addEventListener('touchstart',e=>{
  if(!isMobile())return;
  sheetDragging=true;
  sheetStartY=e.touches[0].clientY;
  sidebar.style.transition='none';
},{passive:true});
document.addEventListener('touchmove',e=>{
  if(!sheetDragging)return;
  const dy=e.touches[0].clientY-sheetStartY;
  const isOpen=sidebar.classList.contains('sheet-open');
  const base=isOpen?0:sidebar.offsetHeight-60;
  const y=Math.max(0,Math.min(sidebar.offsetHeight-60,base+dy));
  sidebar.style.transform=`translateY(${y}px)`;
},{passive:true});
document.addEventListener('touchend',()=>{
  if(!sheetDragging)return;
  sheetDragging=false;
  sidebar.style.transition='';
  const current=new DOMMatrix(getComputedStyle(sidebar).transform).m42;
  const threshold=sidebar.offsetHeight*0.4;
  if(current>threshold){sidebar.style.transform='';closeSheet()}
  else{sidebar.style.transform='';openSheet()}
});

/* Invalidate map size on resize (bottom sheet can obscure) */
window.addEventListener('resize',()=>{setTimeout(()=>map.invalidateSize(),100)});

/* ───── Coordinate helpers ───── */
const c2w=c=>proj4('EPSG:3301','EPSG:4326',[c[0],c[1]]);
const c2e=c=>proj4('EPSG:4326','EPSG:3301',[c[0],c[1]]);

function mapCoords(coords,type,fn){
  if(type==='Polygon')return coords.map(r=>r.map(fn));
  if(type==='MultiPolygon')return coords.map(p=>p.map(r=>r.map(fn)));
  return coords;
}

function calcArea(geojson){
  try{
    const g=geojson.geometry||geojson;
    const pc=mapCoords(g.coordinates,g.type,c2e);
    let total=0;
    const ra=ring=>{let a=0;for(let j=0;j<ring.length-1;j++){a+=ring[j][0]*ring[j+1][1]-ring[j+1][0]*ring[j][1]}return Math.abs(a)/2};
    if(g.type==='Polygon')pc.forEach((r,i)=>total+=(i===0?1:-1)*ra(r));
    else if(g.type==='MultiPolygon')pc.forEach(p=>p.forEach((r,i)=>total+=(i===0?1:-1)*ra(r)));
    return Math.abs(total);
  }catch(e){return turf.area(geojson)}
}

function getBBox(f){
  const c=f.geometry.coordinates;let all=[];
  if(f.geometry.type==='Polygon')all=c[0];else c.forEach(p=>all.push(...p[0]));
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  all.forEach(c=>{x1=Math.min(x1,c[0]);y1=Math.min(y1,c[1]);x2=Math.max(x2,c[0]);y2=Math.max(y2,c[1])});
  return[x1-500,y1-500,x2+500,y2+500];
}

function toWGS(f){
  const g=f.geometry;
  return{type:'Feature',properties:f.properties||{},geometry:{type:g.type,coordinates:mapCoords(g.coordinates,g.type,c2w)}};
}

/* ───── Result card icons ───── */
const cardIcons={
  field:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>',
  area:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>',
  danger:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
  usable:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
  water:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/></svg>'
};

/* ───── Estonian number formatting ───── */
function fmtNum(n,dec=4){
  const parts=n.toFixed(dec).split('.');
  parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
  return parts.join(',');
}
function fmtInt(n){return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g,' ')}

async function search(){
  const num=document.getElementById('fieldNumber').value.trim();
  const buf=parseFloat(document.getElementById('bufferDistance').value)||0;
  if(!num){setStatus('Palun sisesta põllumassiivi number','error');return}

  const btn=document.getElementById('searchBtn');
  btn.disabled=true;
  btn.innerHTML='<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Otsin...';
  document.getElementById('resultsArea').innerHTML='';
  document.getElementById('legendArea').style.display='none';
  const emptyState=document.getElementById('mapEmptyState');
  if(emptyState)emptyState.style.display='none';
  layers.clearLayers();

  try{
    // 1. Põllumassiiv
    setStatus('Otsin põllumassiivi PRIA registrist...','loading');
    const fr=await fetch(`/api/field/${num}`);
    const fd=await fr.json();
    if(fd.error)throw new Error(fd.error);
    if(!fd.features||!fd.features.length)throw new Error(`Massiivi ${num} ei leitud PRIA registrist`);

    const ff=fd.features[0],fp=ff.properties,fw=toWGS(ff);
    const fl=L.geoJSON(fw,{style:{color:'#5cb85c',fillColor:'#5cb85c',fillOpacity:.25,weight:2.5}})
      .bindPopup(`<b>Massiiv ${num}</b><br>Pindala: ${fp.pindala?(fp.pindala/10000).toFixed(2)+' ha':'teadmata'}`);
    layers.addLayer(fl);
    map.fitBounds(fl.getBounds(),{padding:[60,60]});

    // 2. Veekaitsevööndid
    setStatus('Otsin veekaitsevööndeid...','loading');
    const bbox=getBBox(ff);
    const wr=await fetch(`/api/water-zones?bbox=${bbox.join(',')}`);
    const wd=await wr.json();
    if(wd.error)throw new Error(wd.error);
    const wz=wd.features||[];

    if(!wz.length){
      setStatus('Veekaitsevööndeid selle massiivi läheduses ei leitud.','success');
      showResults(fw,fp,[],0,buf);
      btn.disabled=false;
      btn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Otsi ja arvuta';
      document.getElementById('legendArea').style.display='block';
      if(isMobile())openSheet();
      return;
    }

    setStatus(`Leitud ${wz.length} veekaitsevööndit. Arvutan...`,'loading');
    const ww=wz.map(toWGS);

    // Joonista veekaitsevööndid
    ww.forEach(w=>{
      const n=w.properties.objekti_nimetus||w.properties.voondi_nimetus||w.properties.nimi||'Veekaitsevöönd';
      layers.addLayer(L.geoJSON(w,{style:{color:'#3a7bd5',fillColor:'#3a7bd5',fillOpacity:.2,weight:1.5,dashArray:'4 4'}}).bindPopup(`<b>${n}</b>`));
    });

    // 3. Ühenda ja puhverda
    let merged=ww[0];
    for(let i=1;i<ww.length;i++){try{merged=turf.union(merged,ww[i])}catch(e){}}

    let buffered=merged;
    if(buf>0){
      try{
        buffered=turf.buffer(merged,buf/1000,{units:'kilometers'});
        layers.addLayer(L.geoJSON(buffered,{style:{color:'#f0ad4e',fillColor:'#f0ad4e',fillOpacity:.15,weight:1.5,dashArray:'6 3'}}).bindPopup(`Puhverala (+${buf}m)`));
      }catch(e){}
    }

    // 4. Kattuvus
    let overlapArea=0;
    try{
      const ov=turf.intersect(fw,buffered);
      if(ov){
        overlapArea=calcArea(ov);
        layers.addLayer(L.geoJSON(ov,{style:{color:'#d9534f',fillColor:'#d9534f',fillOpacity:.4,weight:2.5}}).bindPopup(`<b>Vähendatav ala</b><br>${fmtNum(overlapArea/10000)} ha`));
      }
    }catch(e){
      for(const w of ww){
        try{
          const z=buf>0?turf.buffer(w,buf/1000,{units:'kilometers'}):w;
          const i=turf.intersect(fw,z);
          if(i){overlapArea+=calcArea(i);layers.addLayer(L.geoJSON(i,{style:{color:'#d9534f',fillColor:'#d9534f',fillOpacity:.4,weight:2.5}}))}
        }catch(e2){}
      }
    }

    setStatus(overlapArea>0
      ?`Kattuvus leitud! Vähendatav ala: ${(overlapArea/10000).toFixed(4)} ha`
      :'Veekaitsevööndid ei kattu selle põllumassiiviga.',
      overlapArea>0?'warning':'success');

    showResults(fw,fp,ww,overlapArea,buf);
    document.getElementById('legendArea').style.display='block';

    // Auto-open sheet on mobile when results arrive
    if(isMobile())openSheet();

  }catch(err){
    console.error(err);
    setStatus(err.message||'Viga andmete laadimisel','error');
  }
  btn.disabled=false;
  btn.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Otsi ja arvuta';
}

function showResults(field,props,waterZones,overlapArea,bufferDist){
  const fa=calcArea(field),fh=fmtNum(fa/10000),oh=fmtNum(overlapArea/10000);
  const eh=fmtNum((fa-overlapArea)/10000),op=fa>0?((overlapArea/fa)*100).toFixed(1).replace('.',','):0;

  let h='<hr class="divider"><section class="results" aria-label="Tulemused">';

  // Põllumassiiv card
  h+=`<article class="result-card"><header class="result-header">${cardIcons.field}<h3>Põllumassiiv</h3></header><p class="result-value">${props.xy_id||'N/A'}</p><p class="result-sub">${[props.maakond,props.vald].filter(Boolean).join(', ')}</p></article>`;

  // Pindala card
  h+=`<article class="result-card"><header class="result-header">${cardIcons.area}<h3>Massiivi pindala</h3></header><p class="result-value">${fh}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(fa)} m²</p></article>`;

  // Vähendatav ala card
  h+=`<article class="result-card ${overlapArea>0?'result-highlight':''}"><header class="result-header">${cardIcons.danger}<h3>Vähendatav ala ${bufferDist>0?`(+${bufferDist}m puhver)`:'(ilma puhvrita)'}</h3></header><p class="result-value">${oh}<span class="unit">ha</span></p><p class="result-sub">${fmtInt(overlapArea)} m² · <span class="result-badge ${overlapArea>0?'result-badge-danger':'result-badge-success'}">${op}%</span> massiivi pindalast</p></article>`;

  // Kasutatav pindala card
  if(overlapArea>0){
    h+=`<article class="result-card result-positive"><header class="result-header">${cardIcons.usable}<h3>Kasutatav pindala</h3></header><p class="result-value">${eh}<span class="unit">ha</span></p><p class="result-sub">Massiivi pindala miinus vähendatav ala</p></article>`;
  }

  // Veekaitsevööndid card
  if(waterZones.length){
    h+=`<article class="result-card"><header class="result-header">${cardIcons.water}<h3>Leitud veekaitsevööndid</h3><span class="result-badge result-badge-success">${waterZones.length}</span></header><ul class="water-details">`;
    waterZones.forEach((w,i)=>{
      const name=w.properties.objekti_nimetus||w.properties.voondi_nimetus||w.properties.nimi||'Nimeta';
      h+=`<li class="water-row"><span class="water-badge">${i+1}</span><span class="water-name">${name}</span></li>`;
    });
    h+='</ul></article>';
  }

  h+='</section>';
  document.getElementById('resultsArea').innerHTML=h;
}
</script>
</body>
</html>
